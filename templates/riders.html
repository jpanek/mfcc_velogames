<!-- templates/race.html -->
{% extends 'base.html' %}

{% block title %}MFCC Velogames{% endblock %}

{% block content %}
<script>
    function redirectToLink(row) {
        window.location.href = row.getAttribute("data-url");
    }
</script>

<div class="text-center mb-4">
    <h1 class="h3 mb-3">{{ title }}</h1>
    
    <div class="d-flex justify-content-center">
        <ul class="nav nav-underline small">
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'main.race' %}active link-dark fw-bold{% else %}link-secondary{% endif %}" 
                   href="{{ url_for('main.race', race_id=request.args.get('race_id')) }}">Stages & Results</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'main.riders' %}active link-dark fw-bold{% else %}link-secondary{% endif %}" 
                   href="{{ url_for('main.riders', race_id=request.args.get('race_id')) }}">Rider Stats</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'main.teams' %}active link-dark fw-bold{% else %}link-secondary{% endif %}" 
                   href="{{ url_for('main.teams', race_id=request.args.get('race_id')) }}">Team Stats</a>
            </li>
        </ul>
    </div>
</div>

<div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-12 col-md-11">
        <canvas id="scatterChart" style="width: 100%; height: 500px;"></canvas>
      </div>
    </div>
</div>


  

<!-- Search for rider by name box: -->
<div style="display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; padding: 10px;">

    <!-- Table -->
    <div class="row">
        
        <div class="col-12 col-lg-10 mx-auto">
            <div class="d-flex justify-content-between align-items-end mb-3">
                <div class="flex-grow-1" style="max-width: 300px;">
                    <label for="searchInput" class="form-label small fw-bold">Search Riders</label>
                    <input type="text" id="searchInput" placeholder="Search by rider name..." class="form-control">
                </div>
                
                <button id="copyRidersBtn" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-clipboard"></i> Copy Rider/Cost List
                </button>
            </div>
    
            <div class="table-responsive">
                <table class="table table-bordered table-hover mt-2 mx-lg-auto w-auto sortable-table">
                    <thead class="table-primary text-center small">
                        <tr>
                            {% for column in columns[3:] %}
                                <th class="text-nowrap" onclick="sortTable(this, {{ loop.index0 }})" style="cursor: pointer;">
                                    {{ column }} 
                                    <span class="sort-arrow small" style="margin-left: 5px; opacity: 0.6;">▲▼</span>
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="small">
                        {% for row in data %}
                            <tr data-url="{{ url_for('main.rider', race_id=row['race_id'], rider_code=row['rider_code']) }}" 
                                onclick="redirectToLink(this)" 
                                style="cursor: pointer;">
                                {% for cell in row[3:] %}
                                    <td class="{% if cell is number %}numeric{% endif %} text-nowrap" 
                                        style="padding: 8px 12px; text-align: {% if cell is number %}right{% else %}left{% endif %};">
                                        {{ "{:,.0f}".format(cell) if cell is number else cell }}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Scatter plot for Riders --> 
<script>
    const chartData = {{ chart_data|safe }};

    const ctx = document.getElementById('scatterChart').getContext('2d');
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Cost vs Points',
                data: chartData,
                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                pointRadius: 7,
                pointHoeverRadius: 10,
                borderColor: 'rgba(255, 99, 132, 1)'
            }]
        },
        options: {
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return `${point.label}: (${point.x}, ${point.y})`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Cost' }
                },
                y: {
                    title: { display: true, text: 'Points' }
                }
            }
        }
    });
</script>

<!-- Sorting table by columns -->
<script>
    function sortTable(header, columnIndex) {
        let table = header.closest("table");
        let tbody = table.querySelector("tbody");
        let rows = Array.from(tbody.querySelectorAll("tr"));
        let ascending = header.dataset.order !== "asc";
    
        rows.sort((rowA, rowB) => {
            let cellA = rowA.children[columnIndex].innerText.trim().replace(/,/g, '');
            let cellB = rowB.children[columnIndex].innerText.trim().replace(/,/g, '');
    
            let a = isNaN(cellA) ? cellA.toLowerCase() : parseFloat(cellA);
            let b = isNaN(cellB) ? cellB.toLowerCase() : parseFloat(cellB);
    
            return ascending ? (a > b ? 1 : -1) : (a < b ? 1 : -1);
        });
    
        tbody.append(...rows);
        header.dataset.order = ascending ? "asc" : "desc";
    
        // Reset all sort arrows
        document.querySelectorAll(".sort-arrow").forEach(el => el.innerHTML = "▲▼");
    
        // Update the clicked column's sort arrow
        let arrow = header.querySelector(".sort-arrow");
        arrow.innerHTML = ascending ? "▲" : "▼";
    }
    
</script>

<!-- Functino: Filtering -->
<script>
    // Filter table based on input
    document.getElementById('searchInput').addEventListener('keyup', function() {
        var filter = this.value.toLowerCase();
        var table = document.getElementById('tableBody');
        var rows = table.getElementsByTagName('tr');
        
        for (var i = 0; i < rows.length; i++) {
            var firstCell = rows[i].getElementsByTagName('td')[0]; // Accessing the first column (index 0)
            if (firstCell) {
                var textValue = firstCell.textContent || firstCell.innerText;
                if (textValue.toLowerCase().indexOf(filter) > -1) {
                    rows[i].style.display = ""; // Show row
                } else {
                    rows[i].style.display = "none"; // Hide row
                }
            }
        }
    });
</script>


<script>
document.getElementById('copyRidersBtn').addEventListener('click', function() {
    const table = document.querySelector(".sortable-table");
    const headers = Array.from(table.querySelectorAll("th")).map(th => th.innerText.trim());
    
    // Find column indices for "Rider" and "Cost"
    const riderIdx = headers.findIndex(h => h.includes("Rider"));
    const costIdx = headers.findIndex(h => h.includes("Cost"));

    if (riderIdx === -1 || costIdx === -1) {
        alert("Could not find Rider or Cost columns.");
        return;
    }

    const rows = Array.from(document.querySelectorAll("#tableBody tr"));
    let copyText = "Rider_name, Cost\n";

    rows.forEach(row => {
        // Only copy rows that are currently visible (important for filtered results)
        if (row.style.display !== "none") {
            const cells = row.querySelectorAll("td");
            const name = cells[riderIdx].innerText.trim();
            const cost = cells[costIdx].innerText.trim();
            copyText += `${name}, ${cost}\n`;
        }
    });

    // Copy to clipboard
    navigator.clipboard.writeText(copyText).then(() => {
        const originalText = this.innerHTML;
        this.innerHTML = "✅ Copied!";
        this.classList.replace('btn-outline-primary', 'btn-success');
        
        setTimeout(() => {
            this.innerHTML = originalText;
            this.classList.replace('btn-success', 'btn-outline-primary');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
});
</script>

{% endblock %}
